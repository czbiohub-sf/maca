---
title: "tenx vs Plate"
output:
  html_document:
    df_print: paged
---

```{r}
library(tidyverse)
library(RColorBrewer)
library(stringr)
library(Seurat)

Sys.setenv(R_MAX_NUM_DLLS=150)
```

Extract just the metadata from plates and tenx cells.
```{r}
just_plates = as_tibble(tiss@meta.data[c('tissue', 'subtissue', 'percent.ribo', 'percent.Rn45s','nGene', 'plate.barcode', 'nReads')])
just_plates <- rownames_to_column(just_plates, "cell")
just_plates['method'] <- 'plate'
just_plates <- rename(just_plates, run = plate.barcode)
just_plates <- rename(just_plates, nMolecules = nReads)

just_tenx = as_tibble(tissX@meta.data[c('tissue', 'percent.ribo', 'nGene','channel', 'percent.Rn45s', 'nUMI')])
just_tenx <- rownames_to_column(just_tenx, "cell")
just_tenx <- rename(just_tenx, nMolecules = nUMI)

just_tenx['method'] <- 'tenx'
just_tenx <- rename(just_tenx, run = channel)

df <- bind_rows(just_plates, just_tenx)
```

Rename mammary from tenx and check tissue counts.

```{r}
df <- df %>% mutate(tissue = fct_recode(tissue,
    "Mammary_Gland" = "Mammary"))
df %>% count(tissue)
```

```{r}
common_tissues <- as.character(df %>% 
                                 group_by(tissue, method) %>% summarize(count = n()) %>% 
                                 ungroup() %>% group_by(tissue) %>% summarize(count = n()) %>% 
                                 filter(count > 1) %>% pull(tissue))
common_tissues
```

## Differences in genes and ribo fraction for plates and tenx.

```{r, fig.width = 12, fig.height = 8}

filter(df, tissue %in% common_tissues) %>% ggplot(aes(nGene, ..density..,colour = method)) + 
  geom_freqpoly(binwidth = 300) +
  facet_wrap(~ tissue, ncol = 4) + 
  ggtitle("Number of genes expressed")

ggsave('figures/ngenes_comparison.pdf', width = 7, height = 7, units = "in")
```


```{r, fig.width = 12, fig.height = 8}
filter(df, tissue %in% common_tissues) %>% ggplot(aes(percent.ribo, ..density..,colour = method)) + 
  geom_freqpoly(binwidth = 0.02) +
  facet_wrap(~ tissue, ncol = 4) + 
  ggtitle("Percent ribosomal protein")

ggsave('figures/percent_ribo_comparison.pdf', width = 7, height = 7, units = "in")
```

```{r, fig.width = 12, fig.height = 8}

filter(df, tissue %in% common_tissues) %>% ggplot(aes(percent.Rn45s, ..density..,colour = method)) + 
  geom_freqpoly(binwidth = 0.02) +
  facet_wrap(~ tissue, ncol = 4) + 
  ggtitle("Percent Rn45s")

ggsave('figures/percent_rn45s_comparison.pdf', width = 7, height = 7, units = "in")
```

The enrichment of Rn45s and ribosomal genes differ strongly between the two methods.

```{r}
tissue_colors <- read_csv('~/maca/metadata/tissue_colors.csv')
tissue_colors <- rename(tissue_colors, tissue = X1)
```

```{r}
medians <- df %>% group_by(method, tissue, run) %>% 
                  summarize(median_Rn45s = median(percent.Rn45s), 
                            median_ribo = median(percent.ribo),
                            n_cells = n()) 
medians <- left_join(medians, tissue_colors, by = 'tissue')

medians %>% filter(tissue %in% common_tissues,) %>% ggplot(aes(x = median_Rn45s, y = median_ribo, color = color, shape = method)) + geom_point()  +
  scale_color_identity(breaks = tissue_colors$color,
                       labels = tissue_colors$tissue,
                       guide = "legend") + 
  ggtitle("Comparing Rn45s and ribo genes between channels and plates.")

ggsave('figures/rn45s_vs_percent_ribo.pdf', width = 7, height = 7, units = "in")
```


```{r}
tiss@meta.data 
```


##  Dynamic Range of individual cells

We compare individual cells from tissues containing similar numbers of genes per cell.


Get a few cells from each method with values in a certain range.

```{r}
subset.size <- 1
set.seed(1)
cell.subset <- filter(df, tissue == 'Heart', nGene > 2900, nGene < 3100) %>% 
    group_by(method) %>% 
    sample_n(subset.size) %>%
    pull(cell)
```

It's difficult to compare UMI and reads apples to apples. Here both are scaled to 10k reads/UMIs then log(1+x)'d.

```{r, fig.width = 4, fig.height = 8}
pdf('figures/heart_cell_comparison.pdf')
par(mfrow=c(2,1))

expr <- tissX@data[,cell.subset[2]]
expr <- expr[expr > 0]
plot(sort(expr), ylab = "log expression", xlab = "gene index", col = "red")
title(main = "Heart tenx cell")

expr <- tiss@data[,cell.subset[1]]
expr <- expr[expr > 0]
plot(sort(expr), ylab = "log expression", xlab = "gene index", col = "green")
title(main = "Heart plateseq cell")

dev.off()
```

If we instead scaled plates to 10^6, we would see a different shape for the plate data, with more dynamic range in the low values.

```{r}
adjust_lognorm = function(x, rescaling) log1p(rescaling*(exp(x)-1))
```


```{r, fig.width = 4, fig.height = 8}
pdf('figures/heart_cell_comparison.pdf')

par(mfrow=c(2,1))

expr <- adjust_lognorm(tissX@data[,cell.subset[2]], 1)
expr <- expr[expr > 0]
plot(sort(expr), ylab = "log expression", xlab = "gene index", col = "red")
title(main = "Heart tenx cell")

expr <- adjust_lognorm(tiss@data[,cell.subset[1]], 100)
expr <- expr[expr > 0]
plot(sort(expr), ylab = "log expression", xlab = "gene index", col = "green")
title(main = "Heart plateseq cell")

dev.off()
```

```{r}

median_cell <- function(stiss, tissue_name, annotation_name){
  med = median(stiss@meta.data %>% filter(tissue == tissue_name, annotation == annotation_name) %>% pull(nGene))
  cell = stiss@meta.data %>% filter(tissue == tissue_name, annotation == annotation_name, nGene > med - 20, nGene < med + 20) %>%
  sample_n(1) %>% pull(cell)
  
  cell
}
```

```{r, fig.width = 4, fig.height = 8}
pdf('figures/Hepatocyte_cell_comparison.pdf')

par(mfrow=c(2,1))

tissue_name = "Liver"
cell_type = "hepatocytes"

tenx_cell = median_cell(tissX, tissue_name, cell_type)
plate_cell = median_cell(tiss, tissue_name, cell_type)

expr <- tissX@data[,tenx_cell]
expr <- expr[expr > 0]
plot(sort(expr), ylab = "log normalized expression", xlab = "gene index", col = "red")
title(main = paste0("Hepatocyte - 10x"))

expr <- adjust_lognorm(tiss@data[,plate_cell], 100)
expr <- expr[expr > 0]
plot(sort(expr), ylab = "log  normalized expression", xlab = "gene index", col = "green")
title(main = paste0("Hepatocyte - plate"))

dev.off()
```

```{r, fig.width = 4, fig.height = 8}
#pdf('figures/Kidney_fibroblast_cell_comparison.pdf')

par(mfrow=c(2,1))

tissue_name = "Kidney"
cell_type = "fibroblasts"

tenx_cell = median_cell(tissX, tissue_name, cell_type)
plate_cell = median_cell(tiss, tissue_name, cell_type)

expr <- tissX@data[,tenx_cell]
expr <- expr[expr > 0]
plot(sort(expr), ylab = "log normalized expression", xlab = "gene index", col = "red")
title(main = paste0("Kidney fibroblast - 10x"))

expr <- adjust_lognorm(tiss@data[,plate_cell], 100)
expr <- expr[expr > 0]
plot(sort(expr), ylab = "log  normalized expression", xlab = "gene index", col = "green")
title(main = paste0("Kidney fibroblast - plate"))

dev.off()
```

```{r, fig.width = 4, fig.height = 8}
pdf('figures/Spleen_b_cell_comparison.pdf')

par(mfrow=c(2,1))

tissue_name = "Spleen"
cell_type = "b_cells"

tenx_cell = median_cell(tissX, tissue_name, cell_type)
plate_cell = median_cell(tiss, tissue_name, cell_type)

expr <- tissX@data[,tenx_cell]
expr <- expr[expr > 0]
plot(sort(expr), ylab = "log normalized expression", xlab = "gene index", col = "red")
title(main = paste0("Spleen B cell - 10x"))

expr <- adjust_lognorm(tiss@data[,plate_cell], 100)
expr <- expr[expr > 0]
plot(sort(expr), ylab = "log  normalized expression", xlab = "gene index", col = "green")
title(main = paste0("Spleen B cell - plate"))

dev.off()
```


## Comparing the Average (T cell)

```{r}
anno_plate = read_csv('~/maca/metadata/maca_3month_combined_cell_annotations.csv')
anno_plate <- rename(anno_plate, cell = X1)
#anno_plate <- rename(anno, anno_tissue = tissue)
anno_plate %>% group_by(tissue, annotation, subannotation) %>% summarize(count = n())

anno_tenx = read_csv('~/maca/metadata/maca_3month_combined_cell_annotations_10x.csv')
anno_tenx <- rename(anno_tenx, cell = X1)
#anno_plate <- rename(anno, anno_tissue = tissue)
anno_tenx %>% group_by(tissue, annotation, subannotation) %>% summarize(count = n())
```


```{r}
library(scales)
```

```{r}
plate_v_tenx <- function(tissue_var, annotation_var){

cells_plate <- anno_plate %>% filter(annotation == annotation_var & tissue == tissue_var) %>% pull(cell)
pct_plate <- Matrix::rowMeans(tiss@raw.data[,cells_plate] > 0)
pct_plate
cells_tenx <- anno_tenx %>% filter(annotation == annotation_var & tissue == tissue_var) %>% pull(cell)
pct_tenx <- Matrix::rowMeans(tissX@raw.data[,cells_tenx] > 0)

pct1 = as_data_frame(pct_tenx)
pct1['gene'] <- names(pct_tenx)
pct1['method'] <- 'tenx'
pct1 <- filter(pct1, value > 0.01)

pct2 = as_data_frame(pct_plate)
pct2['gene'] <- names(pct_plate)
pct2['method'] <- 'plate'
pct2 <- filter(pct2, value > 0.01)

pct <- bind_rows(pct1, pct2)

pct  %>% spread(key = method, value = value, fill = 0) %>% 
  ggplot(aes(x = plate, y = tenx)) + geom_hex() + geom_abline(slope=1, intercept=0)  + scale_fill_continuous(trans = log10_trans())
}
```

```{r}
FetchData(tissX, c('annotation', 'anno_tissue', 'channel')) %>% group_by(annotation, anno_tissue, channel) %>% count()
```

```{r}

cells_tenx1 <- FetchData(tissX, c('annotation', 'anno_tissue', 'channel','cell')) %>% filter(annotation == 'basal_epithelial' & anno_tissue == 'Mammary' & channel == '10X_P7_12') %>% pull(cell)
pct_tenx1 <- Matrix::rowMeans(tissX@raw.data[,cells_tenx1] > 0)

pct1 = as_data_frame(pct_tenx1)
pct1['gene'] <- names(pct_tenx1)
pct1['channel'] <- 'channel1'
pct1 <- filter(pct1, value > 0.01)


cells_tenx2 <- FetchData(tissX, c('annotation', 'anno_tissue', 'channel','cell')) %>% filter(annotation == 'basal_epithelial' & anno_tissue == 'Mammary' & channel == '10X_P7_13') %>% pull(cell)
pct_tenx2 <- Matrix::rowMeans(tissX@raw.data[,cells_tenx2] > 0)

pct2 = as_data_frame(pct_tenx2)
pct2['gene'] <- names(pct_tenx2)
pct2['channel'] <- 'channel2'
pct2 <- filter(pct2, value > 0.01)

pct <- bind_rows(pct1, pct2)

pct  %>% spread(key = channel, value = value, fill = 0) %>% 
  ggplot(aes(x = channel1, y = channel2)) + geom_hex() + geom_abline(slope=1, intercept=0)  + scale_fill_continuous(trans = log10_trans())
```

```{r}
pct  %>% spread(key = channel, value = value, fill = 0)
```

```{r}
tenx_v_tenx <- function(tissue_var, annotation_var){

cells_tenx <- FetchData(tissX) %>% filter(annotation == annotation_var & tissue == tissue_var) %>% pull(cell)
pct_tenx <- Matrix::rowMeans(tissX@raw.data[,cells_tenx] > 0)

pct1 = as_data_frame(pct_tenx)
pct1['gene'] <- names(pct_tenx)
pct1['method'] <- 'tenx'
pct1 <- filter(pct1, value > 0.01)

pct2 = as_data_frame(pct_plate)
pct2['gene'] <- names(pct_plate)
pct2['method'] <- 'plate'
pct2 <- filter(pct2, value > 0.01)

pct <- bind_rows(pct1, pct2)

pct  %>% spread(key = method, value = value, fill = 0) %>% 
  ggplot(aes(x = plate, y = tenx)) + geom_hex() + geom_abline(slope=1, intercept=0)  + scale_fill_continuous(trans = log10_trans())
}
```

## Examples

```{r}
plate_v_tenx("Kidney", "tubule_cells")
```

```{r}
plate_v_tenx("Bladder", "luminal_cells")
```

```{r}
plate_v_tenx("Bladder", "basal_cells")
```

```{r}
plate_v_tenx("Liver", "hepatocytes") + ggtitle("Liver hepatocytes")
ggsave('figures/Liver_hepatocytes.pdf', width = 7, height = 7, units = "in")
```

```{r}
plate_v_tenx("Kidney", "fibroblasts") + ggtitle("Kidney fibroblasts")
ggsave('figures/Kidney_fibroblasts.pdf', width = 7, height = 7, units = "in")
```

```{r}
plate_v_tenx("Spleen", "b_cells") + ggtitle("Spleen b_cells")
ggsave('figures/Spleen_b_cells.pdf', width = 7, height = 7, units = "in")
```




### Global stats

Let's just go big!

```{r}
anno_plate %>% select(cell, annotation, subannotation, tissue) %>% rename(anno_tissue = tissue) %>% mutate(method = "plate")
anno_tenx %>% select(cell, annotation, subannotation, tissue) %>% rename(anno_tissue = tissue) %>% mutate(method = "tenx")
```

```{r}
all_pct <- tibble(value = double(), gene = character(), method = character(), tissue = character(), annotation = character())

for(tissue_name in unique(tiss@meta.data$anno_tissue)){
  for(annotation_name in filter(tiss@meta.data, anno_tissue == tissue_name) %>% pull(annotation) %>% unique()){
    cells_plate <- tiss@meta.data %>% filter(annotation == annotation_name & anno_tissue == tissue_name) %>% pull(cell)
    pct_plate <- Matrix::rowMeans(tiss@raw.data[,cells_plate] > 0)
    
    pct = as_data_frame(pct_plate)
    pct['gene'] <- names(pct_plate)
    pct['method'] <- 'plate'
    pct['tissue'] <- tissue_name
    pct['annotation'] <- annotation_name
    pct <- filter(pct, value > 0.01)
    
    all_pct <- bind_rows(all_pct, pct)
  }
}

for(tissue_name in unique(tiss@meta.data$anno_tissue)){
  for(annotation_name in filter(tissX@meta.data, anno_tissue == tissue_name) %>% pull(annotation) %>% unique()){
    cells_tenx <- tissX@meta.data %>% filter(annotation == annotation_name & anno_tissue == tissue_name) %>% pull(cell)
    pct_tenx <- Matrix::rowMeans(tissX@raw.data[,cells_tenx] > 0)
    
    pct = as_data_frame(pct_tenx)
    pct['gene'] <- names(pct_tenx)
    pct['method'] <- 'tenx'
    pct['tissue'] <- tissue_name
    pct['annotation'] <- annotation_name
    pct <- filter(pct, value > 0.01)
    
    all_pct <- bind_rows(all_pct, pct)
    }
}
```

```{r}
1+1
```


```{r}
tissX@meta.data$channel
```


```{r}
all_pct <- all_pct %>% mutate(anno_and_tissue = paste(annotation, tissue, sep='-'))

common_anno_tissue <- all_pct %>% group_by(anno_and_tissue, method) %>% summarize(count = n()) %>%
                        ungroup() %>% group_by(anno_and_tissue) %>% summarize(count = n()) %>%
                        filter(count > 1) %>% pull(anno_and_tissue)

pct_comparison <- all_pct %>% filter(anno_and_tissue %in% common_anno_tissue)  %>% spread(key = method, value = value, fill = 0) %>%
        filter(plate > 0.05 | tenx > 0.05) %>% 
        mutate(plate_larger = (plate>tenx),
                   plate_smaller = (plate < tenx)) %>%
        group_by(tissue, anno_and_tissue) %>% summarize(plate_is_larger = sum(plate_larger),
                                                        plate_is_smaller = sum(plate_smaller),
                                                        ngene = n())

rtissue_colors = tissue_colors %>% rename(tissue = anno_tissue)

pct_comparison <- left_join(pct_comparison, rtissue_colors, by = 'tissue')

pct_comparison %>% ggplot(aes(plate_is_larger, plate_is_smaller, xmin = 0, ymin = 0, xmax = 11000, ymax = 11000)) + geom_abline(intercept = 0, slope = 1) + 
   geom_point(aes(color = color), size=2) +
   scale_color_identity(breaks = rtissue_colors$color, 
                        labels = rtissue_colors$tissue, 
                        guide = "legend") + 
  labs(x = 'Genes present more often in plates', y = 'Genes present more often in 10x') +
  
  guides(color = guide_legend(override.aes = list(size=2)))

ggsave('figures/plate_tenx_comparison.pdf')
```

```{r}
ggsave('figures/pct_of_pct_plate_v_tenx_by_cell_type.pdf', width = 12, height = 7, units = "in")
```


```{r}
pct_comparison %>% filter(pct_plate_larger < 0.5)
```


## Miscellaneous

Before computing difference statistics, it would be helpful to know what the distribution of these genes are. In particular, to what extent is the percent of cells in which a gene appears a function of the expression level of that gene? For UMI especially, there may be a clean model in terms of capturing molecules.

If there is some (typical) expression level for that gene in that cell type, and molecules are randomly captured, then we would have a multinomial distribution for expression.

In the literature, people recommend using a negative binomial distribution. These an arise as a gamma-mixture of poissons. Poisson for the capture process (especially for UMI) and gamma for the biological variability upstream.



```{r}
FetchData(tiss, c('Actb','tissue', 'annotation')) %>% filter(annotation == 't_cells' & tissue == 'Thymus') %>% ggplot(aes(Actb, ..density..)) + geom_histogram(binwidth = 0.2)
```

```{r}
FetchData(tissX, c('Actb','tissue', 'annotation')) %>% filter(annotation == 't_cells' & tissue == 'Thymus') %>% ggplot(aes(Actb, ..density..)) + geom_histogram(binwidth = 0.2)
```

Lore says that a negative binomial would be a good fit, though that only makes sense on raw count data.

```{r}
library(MASS)
```


```{r}
cells <- FetchData(tissX, c('tissue', 'annotation', 'cell')) %>% 
  filter(annotation == 't_cells' & tissue == 'Thymus') %>% 
  pull(cell)

umis <- tissX@raw.data[,cells]
p <- umis/Matrix::colSums(umis)
```

```{r}
fit <- fitdistr(umis['Cd8a',], densfun = "negative binomial")
fit$estimate
```

```{r}
nb_sample <- rnbinom(20000, mu = fit$estimate['mu'], size = fit$estimate['size'])
```

In the case when a gene has zero inflation due to not being present in all cells, the negative binomial fit will be off. A mixture model would be more appropriate.

```{r}
ggplot(as_data_frame(umis['Cd8a',]), aes(value)) + geom_histogram(aes(y = ..density..)) + geom_histogram(data = as_data_frame(nb_sample), aes(y = ..density..),fill = "red", alpha = 0.2)
```


### Expression vs abundance

There should be a relationship between expression and abundance. Lowly expressed genes may fail to appear in a cell due to random chance, or because they weren't there after all.

```{r}
crazy_genes = c('Malat1', 'Rn45s')

filtered_raw_expression <- function(sobj, annotation_str, anno_tissue_str, excluded_genes){
  cells <- FetchData(sobj, c('annotation', 'anno_tissue', 'cell')) %>% filter(annotation == annotation_str & anno_tissue == anno_tissue_str) %>% pull(cell)
  dat <- sobj@raw.data[!rownames(sobj@data) %in% excluded_genes,cells]
  dat
}

filtered_raw_expression_subanno <- function(sobj, annotation_str, anno_tissue_str, excluded_genes, rescale){
  cells <- FetchData(sobj, c('subannotation', 'anno_tissue', 'cell')) %>% filter(subannotation == annotation_str & anno_tissue == anno_tissue_str) %>% pull(cell)
  dat <- sobj@raw.data[!rownames(sobj@data) %in% excluded_genes,cells]
  dat
}

filtered_raw_expression_tiss <- function(sobj, anno_tissue_str, excluded_genes){
  cells <- FetchData(sobj, c('annotation', 'anno_tissue', 'cell')) %>% filter(anno_tissue == anno_tissue_str) %>% pull(cell)
  dat <- sobj@raw.data[!rownames(sobj@data) %in% excluded_genes,cells]
  dat
}

filtered_expression <- function(sobj, annotation_str, anno_tissue_str, excluded_genes, rescale){
  cells <- FetchData(sobj, c('annotation', 'anno_tissue', 'cell')) %>% filter(annotation == annotation_str & anno_tissue == anno_tissue_str) %>% pull(cell)
  dat <- adjust_lognorm(sobj@data[!rownames(sobj@data) %in% excluded_genes,cells], rescale)
  dat
}

filtered_expression_tiss <- function(sobj, anno_tissue_str, excluded_genes, rescale){
  cells <- FetchData(sobj, c('annotation', 'anno_tissue', 'cell')) %>% filter(anno_tissue == anno_tissue_str) %>% pull(cell)
  dat <- adjust_lognorm(sobj@data[!rownames(sobj@data) %in% excluded_genes,cells], rescale)
  dat
}

pct_vs_avg <- function(sobj, annotation_str, anno_tissue_str, excluded_genes, rescale){
  dat = filtered_expression(sobj, annotation_str, anno_tissue_str, excluded_genes, rescale)
  pct = Matrix::rowMeans(dat > 0)
  avg = Matrix::rowMeans(dat)
  avg_nonzero = Matrix::rowSums(dat)/Matrix::rowSums(dat > 0)
  df = data_frame(pct, avg, avg_nonzero)
  df['gene'] = row.names(dat)
  ggplot(data_frame(pct, avg), aes(avg, pct)) + geom_point(alpha = 0.1) + geom_point(data=df %>% filter(gene == 'Xist'), colour="red")
  #ggplot(data_frame(pct, avg), aes(avg_nonzero, pct)) + geom_point(alpha = 0.1, color = 'blue')

  #qplot(avg, pct, alpha=I(0.1))
}

plate_scale = 100

pct_vs_avg(tissX, 'fibroblasts', 'Kidney', crazy_genes, 1)
pct_vs_avg(tiss, 'fibroblasts', 'Kidney', crazy_genes, plate_scale)

pct_vs_avg(tissX, 't_cells', 'Thymus', crazy_genes, 1)
pct_vs_avg(tiss, 't_cells', 'Thymus', crazy_genes, plate_scale)

pct_vs_avg(tissX, 'hepatocytes', 'Liver', crazy_genes, 1)
pct_vs_avg(tiss, 'hepatocytes', 'Liver', crazy_genes, plate_scale)

pct_vs_avg(tissX, 'b_cells', 'Spleen', crazy_genes, 1)
pct_vs_avg(tiss, 'b_cells', 'Spleen', crazy_genes, plate_scale)
```

```{r}
r = 

curve(1-(r/(exp(x)-1 + r))^r, 0, 4)
```

```{r}
FetchData(tissX, vars.all = c('nUMI')) %>% 
  ggplot(aes(nUMI, ..density..)) + geom_histogram()
```



```{r}
dat <- filtered_expression(tissX, 'b_cells', 'Spleen', crazy_genes, 1)
pct = Matrix::rowMeans(dat > 0)
avg = Matrix::rowMeans(dat)
avg_nonzero = Matrix::rowSums(dat)/Matrix::rowSums(dat > 0)
df = data_frame(pct, avg, avg_nonzero) %>% mutate(rev_log = - log (1 - pct), exp_avg = exp(avg))
df['gene'] = row.names(dat)
df = df %>% filter(pct < 1.1)

r = 1.2
ggplot(df, aes(exp_avg, rev_log)) + geom_point(alpha = 0.1) + geom_point(data=df %>% filter(gene == 'Xist'), colour="red") + stat_function(fun = function(x) {r*log(r + x - 1) - r*log(r)})

ggplot(df, aes(avg, pct)) + geom_point(alpha = 0.1) + geom_point(data=df %>% filter(gene == 'Xist'), colour="red") + stat_function(fun = function(x) {1-(r/(exp(x)-1 + r))^r})

```

A simple null model: there is a big bag of all the UMIs from an experiment. Each cell is drawn with replacement from that bag. If we fix the number of UMI for each cell and shuffle all the rest around, we can ask how the distributions change. Mean will, of course, be the same, but the number of cells expressing that gene may go up or down.

Even if some genes are correlated to one another, the shuffle profile for each will be correct. IE, this marginalizes. Of course, you can also infer the nonuniform correlations by using the null model too.

```{r}
tiss@meta.data %>% filter(tissue == 'Thymus') %>% group_by(subannotation) %>% count()
```


```{r}
dat = filtered_raw_expression(tissX, 't_cells', 'Thymus', crazy_genes)

#dat = filtered_raw_expression_subanno(tissX, 'double_positive_favoring_cd8+	', 'Thymus', crazy_genes)

#dat = filtered_raw_expression(tissX, 'hepatocytes', 'Liver', crazy_genes)

#dat = filtered_raw_expression(tissX, 'fenestrated_capillary', 'Kidney', crazy_genes)

#dat = filtered_raw_expression_tiss(tissX, 'Kidney', crazy_genes)

#dat = filtered_raw_expression_tiss(tissX, 'Liver', crazy_genes)

pct = Matrix::rowMeans(dat > 0)
lambda = Matrix::rowSums(dat)/sum(dat)
nUMIs = Matrix::colSums(dat)

pred_pct = Matrix::rowMeans(1 - exp(-outer(lambda, nUMIs)))

df = data_frame(pct, pred_pct, lambda)
df['gene'] = row.names(dat)

ggplot(df, aes(pred_pct, pct)) + geom_point(alpha = 0.1) + geom_abline(intercept = 0, slope = 1) + geom_point(data=df %>% filter(gene == 'Kif11'), colour="red") + coord_fixed()
```


```{r}
df %>% mutate(difference = pred_pct - pct) %>% filter(pred_pct > pct + 0.2) %>% arrange(desc(difference))
```

```{r}
#dat = filtered_raw_expression(tissX, 'b_cells', 'Spleen', crazy_genes)

#dat = filtered_raw_expression(tissX, 'hepatocytes', 'Liver', crazy_genes)

dat = filtered_raw_expression_tiss(tissX, 'Spleen', crazy_genes)

#dat = filtered_raw_expression_tiss(tissX, 'Liver', crazy_genes)

pct = Matrix::rowMeans(dat > 0)
lambda = Matrix::rowSums(dat)/sum(dat)
nUMIs = Matrix::colSums(dat)

pred_pct = Matrix::rowMeans(1 - exp(-outer(lambda, nUMIs)))

df = data_frame(pct, pred_pct, lambda)
df['gene'] = row.names(dat)

ggplot(df, aes(pred_pct, pct)) + geom_point(alpha = 0.1) + geom_abline(intercept = 0, slope = 1) + geom_point(data=df %>% filter(gene == 'Xist'), colour="red") + coord_fixed()
```

We can use the distance from the diagonal as a measure of how specific a gene is to sub-populations in the dataset.

```{r}
df %>% mutate(difference = pred_pct - pct) %>% filter(pred_pct > pct + 0.2) %>% arrange(desc(difference))
```

```{r}
FetchData(tissX, vars.all = c('mouse.sex', 'Tmsb4x', 'Xist','annotation')) %>% filter(annotation == 'hepatocytes') %>% 
  ggplot(aes(fill = mouse.sex) )+ geom_histogram(aes(x = Tmsb4x, y = ..density..), alpha = 0.4)
```

This is a very, very bad fit for smartseq data, where after the molecules are sorted, they will be multiplied by some large random factors due to PCR. Perhaps if we turn the tables, the generative model will be easier. We have, for each gene, an expression level lambda. 

```{r}
dat = filtered_raw_expression(tiss, 'b_cells', 'Spleen', crazy_genes)

pct = Matrix::rowMeans(dat > 0)
lambda = Matrix::rowSums(dat)/sum(dat)
nReads = Matrix::colSums(dat)

pred_pct = Matrix::rowMeans(1 - exp(-outer(lambda, nUMIs)))

df = data_frame(pct, pred_pct, lambda)
df['gene'] = row.names(dat)

ggplot(df, aes(pred_pct, pct)) + geom_point(alpha = 0.1) + geom_abline(intercept = 0, slope = 1) + geom_point(data=df %>% filter(gene == 'Xist'), colour="red") + coord_fixed()
```

Perhaps we can rescale to some effective number of reads. This amounts to assuming a constant factor increase in PCR.

```{r}
dat = filtered_raw_expression(tiss, 'b_cells', 'Spleen', crazy_genes)

pct = Matrix::rowMeans(dat > 0)
lambda = Matrix::rowSums(dat)/sum(dat)
nUMIs = Matrix::colSums(dat)

pred_pct = Matrix::rowMeans(1 - exp(-outer(lambda, nUMIs)))

df = data_frame(pct, pred_pct, lambda)
df['gene'] = row.names(dat)

ggplot(df, aes(pred_pct, pct)) + geom_point(alpha = 0.1) + geom_abline(intercept = 0, slope = 1) + geom_point(data=df %>% filter(gene == 'Xist'), colour="red") + coord_fixed()
```

```{r}
FetchData(tiss, vars.all = c('percent.ercc', 'nGene', 'nReads')) %>% ggplot(aes(x = nGene, y = log(nReads), color = percent.ercc)) + geom_point(alpha = 0.1)
```
```{r, fig.width = 8, fig.height = 8}
FetchData(tiss, vars.all = c('percent.ercc', 'nGene', 'nReads', 'tissue')) %>% ggplot(aes(x = log(nReads), y = nGene, color = percent.ercc)) + 
  geom_point(alpha = 0.1) + geom_smooth() + facet_wrap(~tissue)
```

```{r}
FetchData(tiss, vars.all = c('percent.ercc', 'nReads')) %>% ggplot(aes(x = log2(percent.ercc))) + geom_histogram()
FetchData(tiss, vars.all = c('percent.ercc', 'nReads')) %>% ggplot(aes(x = (percent.ercc*nReads))) + geom_histogram() + scale_x_log10() 

```


```{r}
FetchData(tiss, vars.all = c('percent.ercc', 'nGene', 'nReads', 'tissue')) %>% ggplot(aes(x = nGene, y = log2(percent.ercc))) + geom_hex()

```

```{r, fig.width = 8, fig.height = 8}
FetchData(tiss, vars.all = c('percent.ercc', 'nGene', 'nReads', 'tissue', 'annotation')) %>% ggplot(aes(x = nGene, y = log2(nReads * (1-percent.ercc))) + geom_hex() + facet_wrap(~tissue)
```

```{r, fig.width = 8, fig.height = 8}
FetchData(tiss, vars.all = c('percent.ercc', 'nGene', 'nReads', 'tissue', 'annotation')) %>% ggplot(aes(x = nGene, y = log2(percent.ercc))) + geom_hex() + facet_wrap(~tissue)
```

```{r, fig.width = 8, fig.height = 8}
FetchData(tiss, vars.all = c('percent.ercc', 'nGene', 'nReads', 'tissue', 'annotation')) %>% ggplot(aes(x = nGene, y = log2(percent.ercc))) + geom_hex() + facet_wrap(~annotation)
```


```{r}
df = FetchData(tiss, vars.all = c('percent.ercc', 'nGene', 'nReads', 'tissue')) %>% lm(nGene ~ log(nReads) + percent.ercc)
```

