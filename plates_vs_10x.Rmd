---
title: "10x vs Plate"
output:
  html_document:
    df_print: paged
---

```{r}
#install.packages("tidyverse")
library(tidyverse)
library(stringr)
library(Seurat)

Sys.setenv(R_MAX_NUM_DLLS=150)
```

```{r}
load("~/maca/save/All_seurat_tiss.Robj")
load("~/maca/save/10x_All_seurat_tiss.Robj")

tiss@meta.data['cell'] <- rownames(tiss@meta.data)
tissX@meta.data['cell'] <- rownames(tissX@meta.data)

```

Add in percent Rn54s.
```{r}
percent.Rn45s <- Matrix::colSums(tiss@raw.data[c('Rn45s'), ])/Matrix::colSums(tiss@raw.data)
tiss <- AddMetaData(object = tiss, metadata = percent.Rn45s, col.name = "percent.Rn45s")

percent.Rn45s <- tissX@raw.data[c('Rn45s'), ]/Matrix::colSums(tissX@raw.data)
tissX <- AddMetaData(object = tissX, metadata = percent.Rn45s, col.name = "percent.Rn45s")
```

Extract just the metadata from plates and tenx cells.
```{r}
just_plates = as_tibble(tiss@meta.data[c('tissue', 'subtissue', 'percent.ribo', 'percent.Rn45s','nGene', 'plate.barcode', 'nReads')])
just_plates <- rownames_to_column(just_plates, "cell")
just_plates['method'] <- 'plate'
just_plates <- rename(just_plates, run = plate.barcode)
just_plates <- rename(just_plates, nMolecules = nReads)

just_tenx = as_tibble(tissX@meta.data[c('tissue', 'percent.ribo', 'nGene','channel', 'percent.Rn45s', 'nUMI')])
just_tenx <- rownames_to_column(just_tenx, "cell")
just_tenx <- rename(just_tenx, nMolecules = nUMI)

just_tenx['method'] <- '10x'
just_tenx <- rename(just_tenx, run = channel)

df <- bind_rows(just_plates, just_tenx)
```

Rename mammary from tenx and check tissue counts.

```{r}
df <- df %>% mutate(tissue = fct_recode(tissue,
    "Mammary_Gland" = "Mammary"))
df %>% count(tissue)
```

```{r}
common_tissues <- as.character(df %>% 
                                 group_by(tissue, method) %>% summarize(count = n()) %>% 
                                 ungroup() %>% group_by(tissue) %>% summarize(count = n()) %>% 
                                 filter(count > 1) %>% pull(tissue))
common_tissues
```

## Differences in genes and ribo fraction for plates and 10x.

```{r, fig.width = 12, fig.height = 8}
filter(df, tissue %in% common_tissues) %>% ggplot(aes(nGene, ..density..,colour = method)) + 
  geom_freqpoly(binwidth = 300) +
  facet_wrap(~ tissue, ncol = 4) + 
  ggtitle("Number of genes expressed")
```



```{r, fig.width = 12, fig.height = 8}
filter(df, tissue %in% common_tissues) %>% ggplot(aes(percent.ribo, ..density..,colour = method)) + 
  geom_freqpoly(binwidth = 0.02) +
  facet_wrap(~ tissue, ncol = 4) + 
  ggtitle("Percent ribosomal protein")
```

```{r, fig.width = 12, fig.height = 8}
filter(df, tissue %in% common_tissues) %>% ggplot(aes(percent.Rn45s, ..density..,colour = method)) + 
  geom_freqpoly(binwidth = 0.02) +
  facet_wrap(~ tissue, ncol = 4) + 
  ggtitle("Percent Rn45s")
```

The enrichment of Rn45s and ribosomal genes differ strongly between the two methods.

```{r}
tissue_colors <- read_csv('~/maca/metadata/tissue_colors.csv')
tissue_colors <- rename(tissue_colors, tissue = X1)
```

```{r}
medians <- df %>% group_by(method, tissue, run) %>% 
                  summarize(median_Rn45s = median(percent.Rn45s), 
                            median_ribo = median(percent.ribo),
                            n_cells = n()) 
medians <- left_join(medians, tissue_colors, by = 'tissue')

medians %>% filter(tissue %in% common_tissues,) %>% ggplot(aes(x = median_Rn45s, y = median_ribo, color = color, shape = method)) + geom_point()  +
  scale_color_identity(breaks = tissue_colors$color,
                       labels = tissue_colors$tissue,
                       guide = "legend") + 
  ggtitle("Comparing Rn45s and ribo genes between channels and plates.")
```




##  Dynamic Range of individual cells

We compare individual cells from tissues containing similar numbers of genes per cell.


Get a few cells from each method with values in a certain range.
```{r}
subset.size <- 1
set.seed(1)
cell.subset <- filter(df, tissue == 'Heart', nGene > 2900, nGene < 3100) %>% 
    group_by(method) %>% 
    sample_n(subset.size) %>%
    pull(cell)
```

```{r, fig.width = 4, fig.height = 8}
par(mfrow=c(2,1))

expr <- tissX@data[,cell.subset[1]]
expr <- expr[expr > 0]
plot(sort(expr), ylab = "log expression", xlab = "gene index", col = "red")
title(main = "Heart 10x cell")

expr <- tiss@data[,cell.subset[2]]
expr <- expr[expr > 0]
plot(sort(expr), ylab = "log expression", xlab = "gene index", col = "green")
title(main = "Heart plateseq cell")
```







































```{r}
df %>% group_by(annotation.y, tissue, plate.barcode.x) %>% summarize(count = n()) %>% ungroup() %>% group_by(annotation.y, tissue) %>% summarize(n_plates = n()) %>% arrange(desc(n_plates))

df %>% group_by(annotation.y, tissue) %>% summarize(count = n()) %>% ungroup() %>% group_by(annotation.y) %>% summarize(n_tissues = n()) %>% arrange(desc(n_tissues))
```



```{r}
df %>% group_by(annotation.y, subannotation.y) %>% summarize(count = n()) %>% ungroup()
```


endos or epithelial cells

brain endos vs rest?
 ** we can do this

  resident vs infiltrating immune cells in the lung? that wouldneed to be them

```{r}
df %>% group_by(annotation.y, tissue, plate.barcode.x) %>% summarize(count = n()) %>% ungroup() %>% group_by(annotation.y, tissue) %>% summarize(n_plates = n()) %>% arrange(desc(n_plates))
```



```{r, fig.width = 8, fig.height = 20}
filter(df, tissue %in% common_tissues) %>% ggplot(aes(percent.Rn45s, ..density..,colour = method)) + 
  geom_freqpoly(binwidth = 0.02) +
  facet_wrap(~ tissue, ncol = 2)
```


## Comparing the Average T cell

```{r}

```


```{r}

tissue_pct <- function(seurat_obj, tissue){
  cells = rownames(seurat_obj@meta.data[seurat_obj@meta.data$tissue == tissue,])
  expr = seurat_obj@data[,cells]
  pct = Matrix::rowMeans(expr > 0)
  pct
} 

```

```{r}

tissue_avg <- function(seurat_obj, tissue){
  cells = rownames(seurat_obj@meta.data[seurat_obj@meta.data$tissue == tissue,])
  expr = seurat_obj@raw.data[,cells]
  avg = Matrix::rowMeans(expr)
  avg
} 

```

```{r}
tissue_of_interest = "Spleen"
plate_pct = tissue_pct(tiss, tissue_of_interest)
tenx_pct = tissue_pct(tissX, tissue_of_interest)

pct1 = as_data_frame(tenx_pct)
pct1['gene'] <- names(tenx_pct)
pct1['method'] <- 'tenx'
pct1 <- filter(pct1, value > 0.01)

pct2 = as_data_frame(plate_pct)
pct2['gene'] <- names(plate_pct)
pct2['method'] <- 'plate'
pct2 <- filter(pct2, value > 0.01)

pct <- bind_rows(pct1, pct2)
```

```{r}
pct %>% spread(key = method, value = value, fill = 0) %>% 
  ggplot(aes_string("plate", "tenx")) + geom_point(alpha = 0.3) + geom_abline(slope=1, intercept=0) + geom_smooth()
```

```{r}
pct %>% spread(key = method, value = value, fill = 0) %>% filter(plate > 0.10) %>% ggplot(aes(tenx, ..density..)) + geom_freqpoly()

#ggplot(aes_string("plate", "tenx")) + geom_point(alpha = 0.3) + geom_abline(slope=1, intercept=0) + geom_smooth()
```

```{r}
pct %>% spread(key = method, value = value, fill = 0) %>% filter(tenx > 0.10) %>% ggplot(aes(plate, ..density..)) + geom_freqpoly()

#ggplot(aes_string("plate", "tenx")) + geom_point(alpha = 0.3) + geom_abline(slope=1, intercept=0) + geom_smooth()
```



```{r}
pct %>% spread(key = method, value = value, fill = 0) %>% filter(tenx > 0.1 | plate > 0.1) %>% ggplot(aes_string("plate", "tenx")) + geom_hex()
```

```{r}
pct %>% select(value < 0.05)
```


Present in one, absent in the other.


How many tenx cells do you need to get a plate cell?



```{r}
pct %>% filter(value < 0.05) %>% spread(key = method, value = value, fill = 0) %>% ggplot(aes_string("plate", "tenx")) + geom_point()
```



Number of genes above a certain threshold of cells expressing. This could be made into a plot for a given cell type. A histogrammy version of starry night.
```{r}
pct %>% filter(value > 0.05) %>% group_by(method) %>% count()
```

